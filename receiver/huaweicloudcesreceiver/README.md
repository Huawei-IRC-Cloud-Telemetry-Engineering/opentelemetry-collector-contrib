# Huawei Cloud CES Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: metrics   |
| Distributions | [] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fhuaweicloudces%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fhuaweicloudces) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fhuaweicloudces%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fhuaweicloudces) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@heitorganzeli](https://www.github.com/heitorganzeli), [@narcis96](https://www.github.com/narcis96) |

[development]: https://github.com/open-telemetry/opentelemetry-collector#development
<!-- end autogenerated section -->

This receiver contains the implementation of the Huawei Cloud [Cloud Eye Service](https://www.huaweicloud.com/intl/en-us/product/ces.html) (CES) receiver for the OpenTelemetry Collector. The receiver collects metrics from Huawei Cloud's CES service and sends them to the OpenTelemetry Collector for processing and exporting.

## Configuration

The following settings are required:

- `region_name`: The name of the Huawei Cloud region from which metrics are collected. For example, `eu-west-101`. The full list of the available regions can be found [here](https://pkg.go.dev/github.com/huaweicloud/huaweicloud-sdk-go-v3@v0.1.104/services/ces/v1/region).

- `project_id`: The ID of the project in Huawei Cloud. This is used to identify which project's metrics are to be collected. See [Obtaining a Project ID](https://support.huaweicloud.com/intl/en-us/devg-apisign/api-sign-provide-proid.html).

- `period`: The aggregation granularity of metrics retrieved from CES in seconds. For details about the aggregation, see [What Is Rollup?](https://support.huaweicloud.com/intl/en-us/ces_faq/ces_faq_0009.html). Possible values are 1, 300, 1200, 3600, 14400, and 86400.
	- 1: Cloud Eye performs no aggregation and displays raw data.
	- 300: Cloud Eye aggregates data every 5 minutes.
	- 1200: Cloud Eye aggregates data every 20 minutes.
	- 3600: Cloud Eye aggregates data every hour.
	- 14400: Cloud Eye aggregates data every 4 hours.
	- 86400: Cloud Eye aggregates data every 24 hours.
- `filter`: The filter field determines the aggregation method used for the metrics. This aggregation is applied to the data points within the specified period. Valid values for filter include:

    - `average`: Calculates the average value over the period.
    - `min`: Retrieves the minimum value within the period.
    - `max`: Retrieves the maximum value within the period.
    - `sum`: Computes the sum of all data points within the period.
    - `variance`: Calculates the variance (square of the standard deviation) for the data points.

- `no_verify_ssl`: A boolean flag indicating whether SSL verification should be disabled. Set to True to disable SSL verification.

The following settings are optional:

- `initial_delay`: The delay before the first collection of metrics begins. This is a duration field, such as 5s for 5 seconds.

- `collection_interval` (default = `60s`): This is the interval at which this receiver collects metrics. This value must be a string readable by Golang's [time.ParseDuration](https://pkg.go.dev/time#ParseDuration). Valid time units are `ns`, `us` (or `µs`), `ms`, `s`, `m`, `h`.

### Example Configuration

```yaml
receivers:
  huaweicloudcesreceiver:
    collection_interval: 3h
    initial_delay: 5s
    region_name: eu-west-101
    project_id: "project_1"
    period: 300
    filter: average
    no_verify_ssl: True
```

The full list of settings exposed for this receiver are documented [here](./config.go).

### Huawei Cloud SDK Authentication Setup


To ensure secure authentication, the Access Key (AK) and Secret Key (SK) used by the Huawei Cloud SDK must be stored in environment variables. See [Obtaining an AK/SK](https://support.huaweicloud.com/intl/en-us/devg-apisign/api-sign-provide-aksk.html).

Before running the application, you need to set the environment variables `HUAWEICLOUD_SDK_AK` and `HUAWEICLOUD_SDK_SK` in your local environment. Here’s how you can do it:

1. Open your terminal.
2. Set the environment variables by executing the following commands:

    ```sh
    export HUAWEICLOUD_SDK_AK=your-access-key
    export HUAWEICLOUD_SDK_SK=your-secret-key
    ```

3. Verify that the variables are set correctly:

    ```sh
    echo $HUAWEICLOUD_SDK_AK
    echo $HUAWEICLOUD_SDK_SK
    ```

## Converting CES metric representation to Open Telementery metric representation


| Source Field                                | Target Field                                           | Description                                                                                           |
|---------------------------------------------|--------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| **metric_name**                             | `metrics.name`                                          | The name of the metric.                                                                                |
| **unit**                                    | `metrics.unit`                                          | The unit of the metric, e.g., `%`, `bit/s`.                                                           |
| **datapoints.value**                      | `metrics.gauge.dataPoints.asDouble`                     | The value of the metric at the specified timestamp.                                           |
| **datapoints.timestamp**                    | `metrics.gauge.dataPoints.timeUnixNano`                 | The timestamp of the metric in nanoseconds. Converted from milliseconds by multiplying by 1,000,000.  |
| **namespace**                               | `metrics.metadata`                                    | The namespace of the metric, e.g., `SYS.VPC` is stored in the metadata map using the key `namespace`.                                                         |
| **dimensions.name**         | key of `metrics.metadata`                                  | The dimension name stored as metadata key.                                                     |
| **dimensions.value**         | value of `metrics.metadata`                                  | The dimension value stored as metadata value.                                                     |
| **Receiver Config**                                       | `resource.attributes.project.id`                        | The project id used in the configuration file of the receiver.                                                               |
| **Receiver Config**                                       | `resource.attributes.region`                        | The region name used in the configuration file of the receiver.                                                               |
| *N/A*                                       | `resource.attributes.cloud.provider`                    | Set to `"huawei_cloud"` as the cloud provider.                                                        |
| *N/A*                                       | `resource.attributes.service.name`                      | Set to `"ces_service"` to indicate the service name.                                                  |
| *N/A*                                       | `resource.attributes.service.version`                   | Set to `"v1"` as the service version.                                                                 |
| *N/A*                                       | `scopeMetrics.scope.name`                               | Set to `"huawei_cloud_ces"` as the scope name.                                                        |
| *N/A*                                       | `scopeMetrics.scope.version`                            | Set to `"v1"` as the scope version.                                                                   |

### Notes

- The `timestamp` field in the source is converted from milliseconds to nanoseconds in the target field.
- Some fields are added in the target format with constant values to provide additional context and metadata.

### Example:

```json
[
    {
      "unit": "%",
      "datapoints": [
        { "average": 10, "timestamp": 1722580500000 },
        { "average": 20, "timestamp": 1722580800000 }
      ],
      "namespace": "SYS.VPC",
      "metric_name": "upstream_bandwidth_usage",
      "dimensions": [
        {
          "name": "publicip_id",
          "value": "test-baae-4dd9-ad3f-1234"
        }
      ]
    },
    {
      "unit": "bit/s",
      "datapoints": [
        { "average": 1024, "timestamp": 1722580500000},
        { "average": 2048, "timestamp": 1722580800000}
      ],
      "namespace": "SYS.VPC",
      "metric_name": "downstream_bandwidth",
      "dimensions": [
        {
          "name": "publicip_id",
          "value": "test-baae-4dd9-ad3f-1234"
        }
      ]
    }
]
```

converts to

```json
{
  "resourceMetrics": [
    {
      "resource": {
        "attributes": {
            "cloud.provider": "huawei_cloud",
            "project.id": "project_1",
            "region": "eu-west-101"
          }
      },
      "scopeMetrics": [
        {
          "scope": { "name": "huawei_cloud_ces", "version": "v1" },
          "metrics": [
            {
              "name": "upstream_bandwidth_usage",
              "unit": "%",
              "gauge": {
                "dataPoints": [
                  { "timeUnixNano": "1722580500000000000", "asDouble": 10 },
                  { "timeUnixNano": "1722580800000000000", "asDouble": 20 }
                ]
              },
              "metadata": {
                    "publicip_id":  "test-baae-4dd9-ad3f-1234",
                    "system.namespace" : "SYS.VPC"
                }
            }
          ]
        },
        {
          "scope": { "name": "huawei_cloud_ces", "version": "v1" },
          "metrics": [
            {
              "name": "downstream_bandwidth_usage",
              "unit": "%",
              "gauge": {
                "dataPoints": [
                  { "timeUnixNano": "1722580500000000000", "asDouble": 1024 },
                  { "timeUnixNano": "1722580800000000000", "asDouble": 2048 }
                ]
              },
              "metadata": {
                  "publicip_id": "test-baae-4dd9-ad3f-1234",
                  "system.namespace":"SYS.VPC"
              }
            }
          ]
        }
      ]
    }
  ]
}
```